name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      # Django
      SECRET_KEY: ci-not-secret
      DEBUG: "False"

      # MySQL (service name "db")
      DB_NAME: erp
      DB_USER: root
      DB_PASSWORD: root
      DB_HOST: db
      DB_PORT: "3306"

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      RATE_LIMIT_PER_MINUTE: "120"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare env file for docker compose
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            cat > .env << 'EOF'
            SECRET_KEY=ci-not-secret
            DEBUG=False
            DB_NAME=erp
            DB_USER=root
            DB_PASSWORD=root
            DB_HOST=db
            DB_PORT=3306
            REDIS_HOST=redis
            REDIS_PORT=6379
            RATE_LIMIT_PER_MINUTE=120
            EOF
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: docker compose build

      - name: Start dependencies
        run: docker compose up -d db redis

      - name: Wait for MySQL health
        run: |
          for i in {1..40}; do
            cid="$(docker compose ps -q db)"
            status="$(docker inspect --format='{{.State.Health.Status}}' "$cid" 2>/dev/null || true)"
            echo "MySQL health: ${status:-unknown}"
            if [ "$status" = "healthy" ]; then exit 0; fi
            sleep 2
          done
          echo "MySQL did not become healthy"
          docker compose logs --no-color db
          exit 1

      - name: Run migrations
        run: docker compose run --rm -T backend python manage.py migrate --noinput

      - name: Run tests
        run: docker compose run --rm -T backend pytest -q

      - name: Logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color db || true
          docker compose logs --no-color redis || true
          docker compose logs --no-color backend || true

      - name: Teardown
        if: always()
        run: docker compose down -v
